---
title: linux磁盘空间不足问题排查
date: 2018-10-09 10:10:57
tags: [linux,df,du]
---

利用df、du等命令排查linux文件系统磁盘空间不足问题
<!-- more -->

## 背景

系统告警提示某台机器磁盘可用空间不足

## 排查过程

+ 登录机器
+ 列出文件系统的整体磁盘使用量
```
$ df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/mapper/VolGroup-lv_root
                      8.3G  7.9G  400M  89% /
tmpfs                 1.9G   12K  1.9G   1% /dev/shm
/dev/sda1             477M  121M  331M  27% /boot
/dev/mapper/VolGroup-lv_data
                       90G  868M   90G   1% /data
```

+ df显示 / 目录下磁盘使用率最高
+ cd /
+ 查看当前目录下每个文件夹的大小
```
# du -sh *
5.9M    bin
119M    boot
825M    data
164K    dev
29M etc
0   filesystem.check
1.3G    home
607M    lib
21M lib64
16K lost+found
4.0K    media
4.0K    mnt
8.8M    opt
```
如果当前目录下有隐藏文件，可以使用命令`du -sh .[!.]*`

.[!.]* 是正则式, 意思是第一位是点, 第二位是除了点以外的字符, 第三位是任意字符或者不存在，后面可以再加一个" *"来包括非隐藏文件

+ 进入空间最大的目录，继续du -sh *，直到找到占用空间最大的目录或文件

## 相关命令

#### df命令
列出文件系统的整体磁盘使用量
```
-a：列出所有的文件系统，包括系统特有的/proc等文件系统

-k：以KB的容量显示各文件系统

-m：以MB的容量显示各文件系统

-h：以人们较易阅读的GB,MB,KB等格式自行显示

-H：以M=1000K替代M=1024K的进位方式

-T：连同该分区的文件系统名称（例如ext3）也列出

-i：不用硬盘容量，而以inode的数量来显示
```

```
df -hl 查看磁盘剩余空间
 
df -h 查看每个根路径的分区大小
```

#### du命令
评估文件系统的磁盘使用量（常用于评估目录所占容量）
```
-a : 列出所有的文件与目录容量，因为默认仅统计目录下面的文件量而已；

-h : 以人们较易读的容量格式（G/M）显示；

-s : 列出总量，而不列出每个个别的目录占用了容量；

-S : 不包括子目录下的总计，与-s有点差别；

-k : 以KB列出容量显示；

-m : 以MB列出容量显示。
```
与df不一样的是，du会直接到文件系统内查找所有的文件数据。

```
du -sh [目录名] 返回目录总共占的容量。而不单独列出各子项占用的容量 

du -lh --max-depth=1 查看当前目录下一级子文件和子目录占用的磁盘容量。
 
du -sm [文件夹] 返回该文件夹总M数
 
du -h [目录名] 查看指定文件夹下的所有文件大小（包含子文件夹）

du -sh .[!.]* * | sort -hr 显示所有隐藏文件和非隐藏文件的大小并根据占用空间排序的语句

du -a | sort -n -r | head -n 10 在当前目录下找出占用空间最大的前10大文件
    sort:
        -n: 按照字符串表示的数字值来排序
        -r: 按照反序排列
    head:
        -n: 取出前多少行

echo .[!.]*  查看所有隐藏文件
```